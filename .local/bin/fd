#!/bin/bash
set -euo pipefail

DICT_URL="https://raw.githubusercontent.com/kujirahand/EJDict/master/src/"
DICT_DIR="$HOME/.fd"
DICT_FILE="$DICT_DIR/dict.txt"

# ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function print_usage() {
    cat << help_msg
fzf-dictionary v0.2.0
This is the English-Japanese dictionary with fzf.

USAGE:
  fd            Look up word
  fd [word]     Look up word with input

OPTIONS:
  --init        Download dict file
  -h, --help    Display usage

DICT SOURCE:
  https://github.com/kujirahand/EJDict
help_msg
}

# è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹é–¢æ•°
function create_dict() {
    echo "Create dict file to:"
    echo "$DICT_FILE"
    echo ""

    mkdir -p "$DICT_DIR"

    # æ—¢å­˜ã®è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹
    rm --force "$DICT_FILE"

    for file in {a..z}.txt; do
        # curl ãŒå¤±æ•—ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
        if ! curl --fail "${DICT_URL}${file}" >> "$DICT_FILE"; then
            echo "Error: Failed to download ${file}. Exiting."
            exit 1
        fi
    done

    echo ""
    echo "Created dict file:"
    echo "$DICT_FILE"
}

# å˜èªã‚’æ¤œç´¢ã™ã‚‹é–¢æ•°
function find_word() {
    local word=${1:-""}

    # è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ --init ã‚’ä¿ƒã™
    if [[ ! -f "$DICT_FILE" ]]; then
        echo "The dictionary file was not found. Please run 'fd --init' to create the dictionary file."
        exit 1
    fi

    fzf --exact --tiebreak=begin --prompt="ğŸ“– > " --query="$word" < "$DICT_FILE"
}

# ãƒ¡ã‚¤ãƒ³é–¢æ•°
function main() {
    if (( $# == 0 )); then
        find_word
        exit 0
    fi

    # æ¸¡ã•ã‚ŒãŸå¼•æ•°ã§å‡¦ç†ã‚’åˆ†å²ã™ã‚‹
    case "$1" in
        -h | --help )
            print_usage
            ;;

        --init )
            create_dict
            ;;

        * )
            find_word "$1"
            ;;
    esac
}

main "$@"
